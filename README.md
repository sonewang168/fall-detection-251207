# 🛡️ 樂齡守護 v3.0

## 智慧跌倒偵測與遠端監控系統

> 結合 AI 人體姿態辨識、即時影像串流、LINE 通知的完整長照守護解決方案

---

## 📋 目錄

- [系統簡介](#系統簡介)
- [功能特色](#功能特色)
- [系統架構](#系統架構)
- [檔案說明](#檔案說明)
- [快速開始](#快速開始)
- [本機監測模式](#本機監測模式)
- [遠端監控模式](#遠端監控模式)
- [API 設定指南](#api-設定指南)
- [技術規格](#技術規格)
- [常見問題](#常見問題)

---

## 系統簡介

**樂齡守護**是一套專為長者照護設計的智慧監測系統，透過攝影機即時追蹤人體姿態，當偵測到跌倒或異常傾斜時，立即發送 LINE 通知並附上截圖與 AI 分析報告，讓家人第一時間掌握長輩安全狀況。

### 🎯 適用對象

- 👴👵 獨居長者的遠距照護
- 🏠 居家安全監測
- 🏥 長照機構輔助監控
- 👨‍👩‍👧‍👦 子女遠端關心父母

### 💡 核心價值

| 特點 | 說明 |
|------|------|
| **即時偵測** | 毫秒級 AI 姿態分析，快速反應 |
| **智慧通知** | 跌倒警示 + 截圖 + AI 分析一次送達 |
| **雙重模式** | 本機自我監測 / 遠端監控父母 |
| **定時回報** | 每隔 1-4 小時自動發送現況報告 |
| **隱私保護** | 資料儲存於本地，不上傳雲端 |

---

## 功能特色

### 🎨 酷炫開機動畫

- 紫色冷光核心方塊 + 「樂」字 Logo
- 三層旋轉環（青色/紫色/粉紅色）
- 粒子飛舞特效
- 掃描線 + 3D 網格地板
- 漸變載入文字動畫

### 📱 本機監測模式

| 功能 | 說明 |
|------|------|
| 即時攝影機 | 前置鏡頭即時取像 |
| 骨架追蹤 | MediaPipe 33 點肢體節點 |
| 傾斜偵測 | 軀幹角度 + 頭部高度雙重判斷 |
| 跌倒警示 | 連續異常幀數達標觸發通知 |
| 定時回報 | 立即 / 1 / 2 / 3 / 4 小時可選 |
| 倒數計時 | 即時顯示下次回報時間 |
| 紀錄查詢 | 警示與回報歷史紀錄 |

### 🏠 遠端監控模式

| 功能 | 說明 |
|------|------|
| Ngrok 連線 | 輸入網址即可遠端查看 |
| 即時影像 | MJPEG 串流 + 骨架節點繪製 |
| 狀態監控 | 傾斜角度 / 警示次數 / 連線時間 |
| 手動回報 | 立即截圖發送 LINE |
| 測試警報 | 驗證通知功能正常 |
| 定時回報 | 立即 / 1 / 2 / 3 / 4 小時可選 |
| 連線紀錄 | 自動記憶最近 5 筆連線 |

### ⚙️ API 設定管理

| 功能 | 說明 |
|------|------|
| LINE Bot | Token + User ID 設定 |
| Gemini AI | 姿態分析 API Key |
| ImgBB | 截圖上傳 API Key |
| 🗑️ 清除功能 | 一鍵清除已儲存的 Key |
| 💾 儲存功能 | 安全儲存至 localStorage |
| 🧪 測試功能 | 即時驗證 API 是否正常 |
| 狀態顯示 | ✅ 已設定 / ❌ 未設定 |

### 🎚️ 偵測參數調整

| 參數 | 預設值 | 範圍 | 說明 |
|------|--------|------|------|
| 傾斜角度閾值 | 35° | 20-60° | 超過此角度視為異常 |
| 連續異常幀數 | 15 幀 | 5-30 幀 | 連續達標才觸發警示 |

---

## 系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                    樂齡守護 v3.0 系統架構                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐         ┌─────────────┐                   │
│  │  本機監測    │         │  遠端監控    │                   │
│  │  (手機/電腦) │         │  (手機 APP)  │                   │
│  └──────┬──────┘         └──────┬──────┘                   │
│         │                       │                           │
│         ▼                       ▼                           │
│  ┌─────────────┐         ┌─────────────┐                   │
│  │ MediaPipe   │         │ Ngrok 穿透   │                   │
│  │ 瀏覽器端 AI  │         │ HTTPS 加密   │                   │
│  └──────┬──────┘         └──────┬──────┘                   │
│         │                       │                           │
│         │                       ▼                           │
│         │              ┌─────────────────┐                 │
│         │              │ Python 伺服器    │                 │
│         │              │ (父母家電腦)     │                 │
│         │              │ ・Flask Web     │                 │
│         │              │ ・MediaPipe AI  │                 │
│         │              │ ・MJPEG 串流    │                 │
│         │              └────────┬────────┘                 │
│         │                       │                           │
│         ▼                       ▼                           │
│  ┌─────────────────────────────────────────┐               │
│  │              跌倒偵測引擎                 │               │
│  │  ・軀幹傾斜角度計算（肩膀-髖部中點）      │               │
│  │  ・頭部高度比例追蹤                      │               │
│  │  ・連續異常幀數累計                      │               │
│  │  ・冷卻時間防重複通知                    │               │
│  └─────────────────────┬───────────────────┘               │
│                        │                                    │
│                        ▼                                    │
│  ┌─────────────────────────────────────────┐               │
│  │              通知系統                     │               │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │               │
│  │  │ ImgBB   │ │ Gemini  │ │  LINE   │   │               │
│  │  │ 截圖上傳 │ │ AI 分析 │ │ 推播通知 │   │               │
│  │  └────┬────┘ └────┬────┘ └────┬────┘   │               │
│  │       └───────────┴───────────┘         │               │
│  │                   │                      │               │
│  │                   ▼                      │               │
│  │         📱 LINE 訊息推播                 │               │
│  │         ・跌倒警示截圖                   │               │
│  │         ・AI 姿態分析報告                │               │
│  │         ・定時現況回報                   │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 檔案說明

| 檔案 | 用途 | 部署位置 |
|------|------|----------|
| `app.html` | 🌟 整合版 APP（本機+遠端） | GitHub Pages |
| `index.html` | 舊版本機監測頁面 | GitHub Pages |
| `remote_client.html` | 獨立遠端監控客戶端 | GitHub Pages |
| `remote_monitor.py` | Python 遠端監控伺服器 | 父母家電腦 |
| `README.md` | 本說明文件 | GitHub |

### 📁 目錄結構

```
fall-detection-251207/
├── app.html              # 🌟 主要使用（整合版 APP）
├── index.html            # 舊版本機監測
├── remote_client.html    # 獨立遠端客戶端
├── remote_monitor.py     # Python 伺服器
└── README.md             # 說明文件
```

---

## 快速開始

### 📱 方式一：直接使用（推薦）

開啟手機瀏覽器，前往：

```
https://你的帳號.github.io/fall-detection-251207/app.html
```

即可開始使用本機監測功能！

### 💻 方式二：自行部署

1. Fork 本專案到你的 GitHub
2. 開啟 GitHub Pages（Settings → Pages → Deploy from branch）
3. 等待 1-2 分鐘即可存取

---

## 本機監測模式

### 📋 使用步驟

1. **開啟 APP** - 前往 `app.html`
2. **設定 API** - 切換到「設定」頁面，輸入各項 API Key
3. **開始監測** - 回到首頁，點擊「開始監測」
4. **允許攝影機** - 瀏覽器會詢問攝影機權限，請允許
5. **設定回報** - 選擇定時回報間隔（可選）

### 🎯 偵測原理

```
正常站立                    跌倒/傾斜
    
    O ← 頭部                    O
   /|\                        /|
    |  ← 軀幹（垂直）          / | ← 軀幹（傾斜 > 35°）
   / \                       /  |
                            /   |

角度 ≈ 0-15°               角度 > 35° → 觸發警示
```

### ⚠️ 觸發條件

警示會在以下情況觸發：

1. **軀幹傾斜角度 > 35°**（可調整）
2. **或 頭部高度 < 初始高度的 50%**
3. **且 連續異常達 15 幀**（約 0.5 秒）
4. **且 距上次通知超過 60 秒**（冷卻時間）

---

## 遠端監控模式

### 🏠 伺服器端設定（父母家電腦）

#### 1️⃣ 安裝 Python 套件

```bash
pip install flask flask-cors opencv-python mediapipe requests
```

#### 2️⃣ 編輯設定檔

打開 `remote_monitor.py`，修改 CONFIG 區塊：

```python
CONFIG = {
    # LINE Bot 設定
    "line_token": "你的 Channel Access Token",
    "line_user_id": "U...",
    
    # Gemini AI 設定
    "gemini_api_key": "AIza...",
    
    # ImgBB 設定
    "imgbb_api_key": "你的 32 位 API Key",
    
    # 其他參數...
}
```

#### 3️⃣ 啟動伺服器

```bash
# 進入虛擬環境（如有）
cd D:\FallDetect
.\fall_env\Scripts\activate

# 啟動監控伺服器
python remote_monitor.py
```

#### 4️⃣ 啟動 Ngrok 穿透

開啟另一個終端機：

```bash
ngrok http 8085
```

複製產生的 HTTPS 網址，例如：
```
https://xxxx-xxxx.ngrok-free.app
```

### 📱 客戶端使用（你的手機）

1. 開啟 APP：`https://你的帳號.github.io/fall-detection-251207/app.html`
2. 切換到「🏠 遠端監控」模式
3. 貼上 Ngrok 網址
4. 點擊「連線」
5. 即可看到即時影像（含骨架節點）！

### 🌐 網路架構

```
父母家電腦                    網際網路                 你的手機
┌─────────────┐              ┌──────┐              ┌─────────────┐
│ Python 伺服器│              │      │              │  APP 客戶端  │
│ Port 8085   │◄────────────►│Ngrok │◄────────────►│             │
│ + MediaPipe │              │ 穿透  │              │  即時影像    │
└─────────────┘              └──────┘              └─────────────┘
```

---

## API 設定指南

### 💬 LINE Bot 設定

1. 前往 [LINE Developers](https://developers.line.biz/console/)
2. 建立 Provider → 建立 Messaging API Channel
3. 取得 **Channel Access Token**（長期有效）
4. 取得 **Your User ID**（在 Basic settings 頁面）
5. 掃描 QR Code 加入你的 Bot 為好友

### 🤖 Gemini AI 設定

1. 前往 [AI Studio](https://aistudio.google.com/apikey)
2. 點擊「Get API Key」
3. 建立新的 API Key
4. 複製 `AIza...` 開頭的金鑰

### 🖼️ ImgBB 設定

1. 前往 [ImgBB](https://imgbb.com/login) 登入（可用 Google）
2. 前往 [API 頁面](https://api.imgbb.com/)
3. 點擊「Get API Key」
4. 複製 32 位字元的金鑰

### 🔐 Ngrok 設定

1. 前往 [Ngrok](https://ngrok.com/) 註冊
2. 下載 Windows 版本
3. 取得 Authtoken：`ngrok config add-authtoken YOUR_TOKEN`
4. 執行：`ngrok http 8085`

---

## 技術規格

### 🧠 AI 模型

| 項目 | 規格 |
|------|------|
| 姿態偵測 | MediaPipe Pose |
| 模型複雜度 | 1（平衡精度與速度）|
| 偵測點數 | 33 個身體關鍵點 |
| 最低可信度 | 0.5 |

### 📐 偵測演算法

```javascript
// 軀幹角度計算
肩膀中點 = (左肩 + 右肩) / 2
髖部中點 = (左髖 + 右髖) / 2
dx = |肩膀中點.x - 髖部中點.x|
dy = |肩膀中點.y - 髖部中點.y|
角度 = arctan(dx / dy) × (180 / π)

// 頭部高度計算
頭部高度比 = (髖部.y - 鼻子.y) / 初始基準值
```

### 🌐 通訊協定

| 項目 | 規格 |
|------|------|
| 影像串流 | MJPEG (multipart/x-mixed-replace) |
| API 通訊 | RESTful JSON |
| 跨域處理 | CORS + Proxy |
| 安全連線 | HTTPS (Ngrok) |

### 📱 瀏覽器相容性

| 瀏覽器 | 支援狀況 |
|--------|----------|
| Safari (iOS) | ✅ 完整支援 |
| Chrome (Android) | ✅ 完整支援 |
| Chrome (桌面) | ✅ 完整支援 |
| Firefox | ✅ 完整支援 |
| Edge | ✅ 完整支援 |

---

## 常見問題

### ❓ 攝影機無法開啟？

- 確認瀏覽器已允許攝影機權限
- 確認沒有其他程式佔用攝影機
- 嘗試重新整理頁面

### ❓ LINE 通知收不到？

- 確認已加入 Bot 為好友
- 確認 Token 和 User ID 正確
- 使用「測試」按鈕驗證

### ❓ 遠端監控連不上？

- 確認 Python 伺服器正在執行
- 確認 Ngrok 正在執行
- 確認使用最新的 Ngrok 網址
- 免費版 Ngrok 每次重啟網址會變

### ❓ AI 分析失敗？

- 確認 Gemini API Key 正確
- 確認 API 配額尚未用完
- 檢查網路連線

### ❓ 圖片無法上傳？

- 確認 ImgBB API Key 正確
- 確認圖片大小未超過 32MB

---

## 📄 授權資訊

本專案僅供教育與個人使用。

### 使用的開源技術

- [MediaPipe](https://mediapipe.dev/) - Google AI 姿態偵測
- [Flask](https://flask.palletsprojects.com/) - Python Web 框架
- [OpenCV](https://opencv.org/) - 電腦視覺函式庫

---

## 👨‍🏫 開發者

**Sone Wang** - 台灣中學物理教師 / 教育科技開發者

專注於 AI 輔助教學工具與智慧照護應用開發

---

## 🔄 版本紀錄

| 版本 | 日期 | 更新內容 |
|------|------|----------|
| v3.0 | 2024/12/07 | 整合版 APP、酷炫開機動畫、雙模式切換、定時回報 |
| v2.0 | 2024/12/07 | 新增遠端監控、Ngrok 穿透、Python 伺服器 |
| v1.0 | 2024/12/07 | 基礎跌倒偵測、LINE 通知、ImgBB 上傳 |

---

<div align="center">

### 🛡️ 樂齡守護 - 安心守護每一刻

**讓科技成為長照的溫暖助力**

</div>
